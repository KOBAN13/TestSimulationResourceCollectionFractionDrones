# Симуляция сбора ресурсов дронами

Симуляция двух команд дронов (красная и синяя фракции), собирающих ресурсы с использованием Unity и паттерна State Machine.

## Что реализовано

### Основной функционал
- **Симуляция двух команд дронов** - красная и синяя фракции соревнуются за сбор ресурсов
- **Автономное поведение дронов** - каждый дрон самостоятельно ищет, собирает и доставляет ресурсы на базу
- **Динамическое управление параметрами симуляции** через UI:
  - Количество дронов в каждой команде
  - Скорость движения дронов
  - Частота появления ресурсов
  - Визуализация пути дронов
- **Подсчет собранных ресурсов** для каждой команды в реальном времени
- **Визуальные эффекты** при доставке ресурсов

### Технические особенности
- **State Machine** для управления поведением дронов
- **MVP паттерн** для UI (Model-View-Presenter)
- **Dependency Injection** через Zenject
- **Reactive Programming** с использованием R3 (альтернатива UniRx)
- **Object Pooling** для оптимизации создания дронов и ресурсов
- **NavMesh** для навигации дронов

## Архитектура

### Компоненты системы

#### 1. **State Machine (Машина состояний дрона)**
Каждый дрон управляется через машину состояний:

- **FindResource** - поиск ближайшего доступного ресурса
- **MoveToTarget** - движение к найденному ресурсу
- **CollectResource** - сбор ресурса (2 секунды)
- **ReturnToBase** - возврат на базу с собранным ресурсом
- **UnloadResource** - разгрузка ресурса на базе
- **FindResource** - поиск следующего ресурса

#### 2. **MVP для UI**
- **DroneSimulationModel** - хранит состояние симуляции (количество дронов, скорость, собранные ресурсы)
- **DroneSimulationView** - отображает UI и принимает пользовательский ввод
- **DroneSimulationPresenter** - связывает Model и View, обрабатывает события

#### 3. **Сервисы**
- **ResourceDirectory** - управляет доступными ресурсами, резервирует их для дронов
- **EffectPlayer** - воспроизводит визуальные эффекты
- **DroneSpawner** - создает дронов для каждой фракции
- **ResourceSpawner** - генерирует ресурсы на карте

#### 4. **Dependency Injection**
Все зависимости внедряются через `BootstrupContext` (Zenject MonoInstaller):
- Регистрация сервисов
- Настройка фабрик для создания дронов и ресурсов
- Связывание MVP компонентов

### Диаграмма взаимодействия компонентов

```
UI (View) ←→ Presenter ←→ Model
                ↓
         DroneController
                ↓
         StateMachine
         ↓    ↓    ↓
    States (FindResource, MoveToTarget, и т.д.)
         ↓
    Services (ResourceDirectory, EffectPlayer)
```

### Логика работы дрона

1. **Инициализация** (`DroneController.Awake`)
   - Создание контекста дрона (DroneContext)
   - Инициализация всех состояний
   - Запуск State Machine в состоянии FindResource

2. **Рабочий цикл**
   - Поиск ближайшего доступного ресурса через ResourceDirectory
   - Резервирование ресурса для дрона
   - Движение к ресурсу с использованием NavMeshAgent
   - Сбор ресурса (2 секунды)
   - Возврат на базу с собранным ресурсом
   - Разгрузка и обновление счетчика команды
   - Повтор цикла

3. **Управление ресурсами**
   - При резервировании ресурса помечается как занятый
   - При сборе ресурс удаляется из директории
   - При разгрузке обновляется счетчик ресурсов команды
   - При уничтожении дрона зарезервированный ресурс освобождается

## Используемые инструменты и подходы

### Библиотеки и фреймворки
- **Unity 2022+** - игровой движок
- **Zenject** - контейнер Dependency Injection
- **R3** - реактивное программирование (ReactiveProperty, Observable)
- **NavMesh** - система навигации Unity

### Паттерны проектирования
- **State Machine** - управление поведением дронов
- **MVP (Model-View-Presenter)** - архитектура UI
- **Dependency Injection** - управление сервисами
- **Object Pool** - оптимизация создания дронов и ресурсов
- **Factory** - создание дронов и ресурсов
- **Service Locator** - доступ к сервисам через DI

### Принципы разработки
- **SOLID** принципы
- **Разделение ответственности** - каждое состояние отвечает за свою логику
- **Reactive Programming** - изменения в Model автоматически отражаются в View
- **Интерфейсы** - IState, IResourceDirectory, IEffectPlayer для гибкости и тестируемости

### Структура проекта
```
Assets/Scripts/
├── Components/        # DroneController, DroneView
├── Di/               # Zenject installers
├── DroneFactory/     # Фабрики и данные для создания дронов
├── Pool/             # Object pooling
├── ResourceFactory/  # Фабрики и данные для создания ресурсов
├── Services/         # ResourceDirectory, EffectPlayer
├── States/           # Все состояния State Machine
│   ├── FindResource.cs
│   ├── MoveToTarget.cs
│   ├── CollectResource.cs
│   ├── ReturnToBase.cs
│   ├── UnloadingResource.cs
│   ├── StateMachine.cs
│   └── DronStateMachine.cs
├── UI/               # MVP компоненты для UI
└── Utils/            # DroneContext, EDroneFraction, SerializedDictionary
```

## Запуск проекта

1. Откройте проект в Unity 2022 или новее
2. Убедитесь, что установлен Zenject (через Package Manager или Asset Store)
3. Откройте главную сцену
4. Нажмите Play
5. Используйте UI для настройки параметров симуляции

## Управление симуляцией

- **Drone Count (Red/Blue Team)** - количество дронов в команде
- **Drone Speed** - скорость движения дронов
- **Resource Spawn Rate** - частота появления новых ресурсов
- **Show Drone Path** - отображение пути движения дронов (LineRenderer)

## Особенности реализации

### Reactive подход
Все параметры симуляции реализованы через `ReactiveProperty`, что обеспечивает:
- Автоматическое обновление UI при изменении данных
- Подписку дронов на изменение скорости в реальном времени
- Чистую архитектуру без прямых связей между компонентами

### State Machine
Каждое состояние реализует интерфейс `IState`:
```csharp
public interface IState
{
    void OnEnter();
    void OnExit();
    void OnUpdateBehaviour();
    void OnFixedUpdateBehaviour();
    bool TrySwapState();
}
```

Переключение состояний происходит через `DronStateMachine`, который проверяет возможность перехода через `TrySwapState()`.

### Resource Management
`ResourceDirectory` управляет всеми ресурсами на карте:
- `TryReserveNearest()` - резервирует ближайший свободный ресурс
- `Consume()` - удаляет собранный ресурс
- `Release()` - освобождает зарезервированный ресурс

Это предотвращает ситуации, когда несколько дронов пытаются собрать один ресурс.